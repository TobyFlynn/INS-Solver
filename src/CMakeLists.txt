set(KERNEL_HEADERS kernels/init_grid.h kernels/init_edges.h kernels/set_ic.h kernels/calc_dt.h kernels/lift_drag.h kernels/init_nodes.h kernels/save_values.h)
list(APPEND KERNEL_HEADERS kernels/init_cubature.h kernels/init_cubature_grad.h kernels/init_cubature_OP.h)
list(APPEND KERNEL_HEADERS kernels/gauss_tau.h kernels/gauss_tau_bc.h kernels/init_gauss.h kernels/init_gauss_grad.h kernels/init_gauss_grad_neighbour.h kernels/gauss_grad_faces.h kernels/init_gauss_grad2.h kernels/gauss_op.h kernels/gauss_gfi_faces.h kernels/gauss_reverse.h)
list(APPEND KERNEL_HEADERS kernels/div.h kernels/curl.h kernels/grad.h kernels/cub_grad.h kernels/cub_div.h kernels/cub_grad_weak.h kernels/cub_div_weak.h kernels/inv_J.h)
list(APPEND KERNEL_HEADERS kernels/advection_flux.h kernels/advection_faces.h kernels/advection_bc.h kernels/advection_numerical_flux.h kernels/advection_intermediate_vel.h)
list(APPEND KERNEL_HEADERS kernels/pressure_bc.h kernels/pressure_bc2.h kernels/pressure_rhs.h kernels/pressure_update_vel.h)
list(APPEND KERNEL_HEADERS kernels/viscosity_rhs.h kernels/viscosity_reset_bc.h kernels/viscosity_bc.h)
list(APPEND KERNEL_HEADERS kernels/init_surface.h kernels/calc_h.h kernels/set_rkQ.h kernels/update_Q.h)
list(APPEND KERNEL_HEADERS kernels/ls_advec_edges.h kernels/ls_advec_bedges.h kernels/ls_advec_flux.h kernels/ls_advec_rhs.h)
list(APPEND KERNEL_HEADERS kernels/ls_sign.h kernels/ls_flux.h kernels/ls_bflux.h kernels/ls_copy.h kernels/ls_rhs.h kernels/ls_add_diff.h kernels/ls_reinit_check.h)
list(APPEND KERNEL_HEADERS kernels/sigma_flux.h kernels/sigma_bflux.h kernels/sigma_mult.h kernels/diff_flux.h kernels/diff_bflux.h kernels/ls_step.h kernels/init_nu_rho.h)

set(OPENBLAS_SRC openBLAS_op/init_grid_op.cpp openBLAS_op/op2_gemv_op.cpp openBLAS_op/op2_gemm_op.cpp openBLAS_op/op2_gemv_batch_op.cpp openBLAS_op/op2_gemm_batch_op.cpp)
list(APPEND OPENBLAS_SRC openBLAS_op/init_gauss_op.cpp openBLAS_op/init_gauss_grad_op.cpp openBLAS_op/init_gauss_grad_neighbour_op.cpp)

set(CUBLAS_SRC cuBLAS_op/init_grid_op.cu cuBLAS_op/op2_gemv_op.cu cuBLAS_op/op2_gemm_op.cu cuBLAS_op/op2_gemv_batch_op.cu cuBLAS_op/op2_gemm_batch_op.cu)
list(APPEND CUBLAS_SRC cuBLAS_op/init_gauss_op.cu cuBLAS_op/init_gauss_grad_op.cu cuBLAS_op/init_gauss_grad_neighbour_op.cu)

set(COMMON_SRC solver_op.cpp operators_op.cpp ins_data_op.cpp timing_op.cpp ls_op.cpp pressure_solve_op.cpp viscosity_solve_op.cpp)
set(CPU_SRC constants.cpp utils_op.cpp poisson_cpu_op.cpp)
set(GPU_SRC constants.cu utils_op.cu poisson_gpu_op.cu)
set(SN_SRC save_solution_op.cpp load_mesh.cpp)
set(MPI_SRC save_solution_mpi_op.cpp load_mesh_mpi.cpp mpi_helper_func.cpp)

set(GFORT_LIB /gpfs/users/shared/apps/core/gcc/7.3.0/lib64/libgfortran.so.4)

op2_application(ins_seq LIBS op2_seq op2_hdf5 SOURCES ins_op.cpp ${COMMON_SRC} ${CPU_SRC} ${SN_SRC} ${OPENBLAS_SRC} seq/ins_seqkernels.cpp ${KERNEL_HEADERS})
target_include_directories(ins_seq PUBLIC ${PETSC_DIR}/include ${OpenBLAS_INCLUDE_DIRS} ${PROJECT_SOURCE_DIR}/include)
target_link_libraries(ins_seq libcgns.so libhdf5.so ${PETSC_DIR}/lib/libpetsc.so ${OpenBLAS_LIBRARIES} ${GFORT_LIB})

op2_application(ins_openmp LIBS op2_openmp op2_hdf5 SOURCES ins_op.cpp ${COMMON_SRC} ${CPU_SRC} ${SN_SRC} ${OPENBLAS_SRC} openmp/ins_kernels.cpp ${KERNEL_HEADERS})
target_include_directories(ins_openmp PUBLIC ${PETSC_DIR}/include ${OpenBLAS_INCLUDE_DIRS} ${PROJECT_SOURCE_DIR}/include)
target_link_libraries(ins_openmp libcgns.so libhdf5.so ${PETSC_DIR}/lib/libpetsc.so ${OpenBLAS_LIBRARIES} ${GFORT_LIB})

op2_application(ins_cuda LIBS op2_cuda op2_hdf5 SOURCES ins_op.cpp ${COMMON_SRC} ${GPU_SRC} ${SN_SRC} ${CUBLAS_SRC} cuda/ins_kernels.cu ${KERNEL_HEADERS})
target_compile_definitions(ins_cuda PUBLIC -DBUILD_CUDA)
target_include_directories(ins_cuda PUBLIC ${PETSC_DIR}/include ${CUDAToolkit_INCLUDE_DIRS} ${PROJECT_SOURCE_DIR}/include)
target_link_libraries(ins_cuda libcgns.so libhdf5.so ${PETSC_DIR}/lib/libpetsc.so CUDA::cudart_static CUDA::cublas)
set_property(TARGET ins_cuda PROPERTY CUDA_ARCHITECTURES OFF)
target_compile_definitions(ins_cuda PRIVATE INS_CUDA)

op2_application(ins_mpi LIBS op2_mpi op2_hdf5 SOURCES ins_op.cpp ${COMMON_SRC} ${CPU_SRC} ${MPI_SRC} ${OPENBLAS_SRC} seq/ins_seqkernels.cpp ${KERNEL_HEADERS})
target_include_directories(ins_mpi PUBLIC ${PETSC_DIR}/include ${OpenBLAS_INCLUDE_DIRS} ${PROJECT_SOURCE_DIR}/include)
target_link_libraries(ins_mpi libcgns.so libhdf5.so ${PETSC_DIR}/lib/libpetsc.so ${OpenBLAS_LIBRARIES} ${GFORT_LIB} libptscotch.a libscotch.a)
target_compile_definitions(ins_mpi PRIVATE INS_MPI)

op2_application(ins_mpi_openmp LIBS op2_mpi op2_openmp op2_hdf5 SOURCES ins_op.cpp ${COMMON_SRC} ${CPU_SRC} ${MPI_SRC} ${OPENBLAS_SRC} openmp/ins_kernels.cpp ${KERNEL_HEADERS})
target_include_directories(ins_mpi_openmp PUBLIC ${PETSC_DIR}/include ${OpenBLAS_INCLUDE_DIRS} ${PROJECT_SOURCE_DIR}/include)
target_link_libraries(ins_mpi_openmp libcgns.so libhdf5.so ${PETSC_DIR}/lib/libpetsc.so ${OpenBLAS_LIBRARIES} ${GFORT_LIB} libptscotch.a libscotch.a)
target_compile_definitions(ins_mpi_openmp PRIVATE INS_MPI)

op2_application(ins_mpi_cuda LIBS op2_mpi_cuda op2_hdf5 SOURCES ins_op.cpp ${COMMON_SRC} ${GPU_SRC} ${MPI_SRC} ${CUBLAS_SRC} cuda/ins_kernels.cu ${KERNEL_HEADERS})
target_compile_definitions(ins_mpi_cuda PUBLIC -DBUILD_CUDA)
target_include_directories(ins_mpi_cuda PUBLIC ${PETSC_DIR}/include ${CUDAToolkit_INCLUDE_DIRS} ${PROJECT_SOURCE_DIR}/include)
target_link_libraries(ins_mpi_cuda libcgns.so libhdf5.so ${PETSC_DIR}/lib/libpetsc.so CUDA::cudart_static CUDA::cublas libptscotch.a libscotch.a)
set_property(TARGET ins_mpi_cuda PROPERTY CUDA_ARCHITECTURES OFF)
target_compile_definitions(ins_mpi_cuda PRIVATE INS_CUDA INS_MPI)
